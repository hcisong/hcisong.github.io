/*! IV-Project */
/*! 1.0.0 2017-11-22 */

function lines(){function t(t){e.each(function(e){var n=d3.select(this);y.domain([0,e.maxPrice]),n.select("path").attr("d",function(e){return line(e.values.slice(0,t+1))}),n.selectAll("circle, text").data(function(e){return[e.values[t],e.values[t]]}).attr("transform",function(t){return"translate("+x(t.date)+","+y(t.price)+")"})})}x=d3.time.scale().range([0,w-60]),y=d3.scale.linear().range([h/4-20,0]),x.domain([d3.min(symbols,function(t){return t.values[0].date}),d3.max(symbols,function(t){return t.values[t.values.length-1].date})]);var e=svg.selectAll(".symbol").attr("transform",function(t,e){return"translate(0,"+(e*h/4+10)+")"});e.each(function(t){var e=d3.select(this);e.append("path").attr("class","line"),e.append("circle").attr("r",5).style("fill",function(t){return color(t.key)}).style("stroke","#000").style("stroke-width","2px"),e.append("text").attr("x",12).attr("dy",".31em").text(t.key)});var n=1,r=symbols[0].values.length;d3.timer(function(){if(t(n),(n+=2)>=r-1)return t(r-1),setTimeout(horizons,500),!0})}function horizons(){svg.insert("defs",".symbol").append("clipPath").attr("id","clip").append("rect").attr("width",w).attr("height",h/4-20);var t=d3.scale.ordinal().range(["#c6dbef","#9ecae1","#6baed6"]),e=svg.selectAll(".symbol").attr("clip-path","url(#clip)");area.y0(h/4-20),e.select("circle").transition().duration(duration).attr("transform",function(t){return"translate("+(w-60)+","+-h/4+")"}).remove(),e.select("text").transition().duration(duration).attr("transform",function(t){return"translate("+(w-60)+","+(h/4-20)+")"}).attr("dy","0em"),e.each(function(e){y.domain([0,e.maxPrice]),d3.select(this).selectAll(".area").data(d3.range(3)).enter().insert("path",".line").attr("class","area").attr("transform",function(t){return"translate(0,"+t*(h/4-20)+")"}).attr("d",area(e.values)).style("fill",function(e,n){return t(n)}).style("fill-opacity",1e-6),y.domain([0,e.maxPrice/3]),d3.select(this).selectAll(".line").transition().duration(duration).attr("d",line(e.values)).style("stroke-opacity",1e-6),d3.select(this).selectAll(".area").transition().duration(duration).style("fill-opacity",1).attr("d",area(e.values)).each("end",function(){d3.select(this).style("fill-opacity",null)})}),setTimeout(areas,duration+delay)}function areas(){var t=svg.selectAll(".symbol");axis.y(h/4-21),t.select(".line").attr("d",function(t){return axis(t.values)}),t.each(function(t){y.domain([0,t.maxPrice]),d3.select(this).select(".line").transition().duration(duration).style("stroke-opacity",1).each("end",function(){d3.select(this).style("stroke-opacity",null)}),d3.select(this).selectAll(".area").filter(function(t,e){return e}).transition().duration(duration).style("fill-opacity",1e-6).attr("d",area(t.values)).remove(),d3.select(this).selectAll(".area").filter(function(t,e){return!e}).transition().duration(duration).style("fill",color(t.key)).attr("d",area(t.values))}),svg.select("defs").transition().duration(duration).remove(),t.transition().duration(duration).each("end",function(){d3.select(this).attr("clip-path",null)}),setTimeout(stackedArea,duration+delay)}function stackedArea(){d3.layout.stack().values(function(t){return t.values}).x(function(t){return t.date}).y(function(t){return t.price}).out(function(t,e,n){t.price0=e}).order("reverse")(symbols),y.domain([0,d3.max(symbols[0].values.map(function(t){return t.price+t.price0}))]).range([h,0]),line.y(function(t){return y(t.price0)}),area.y0(function(t){return y(t.price0)}).y1(function(t){return y(t.price0+t.price)});var t=svg.selectAll(".symbol").transition().duration(duration).attr("transform","translate(0,0)").each("end",function(){d3.select(this).attr("transform",null)});t.select("path.area").attr("d",function(t){return area(t.values)}),t.select("path.line").style("stroke-opacity",function(t,e){return e<3?1e-6:1}).attr("d",function(t){return line(t.values)}),t.select("text").attr("transform",function(t){return t=t.values[t.values.length-1],"translate("+(w-60)+","+y(t.price/2+t.price0)+")"}),setTimeout(streamgraph,duration+delay)}function streamgraph(){d3.layout.stack().values(function(t){return t.values}).x(function(t){return t.date}).y(function(t){return t.price}).out(function(t,e,n){t.price0=e}).order("reverse").offset("wiggle")(symbols),line.y(function(t){return y(t.price0)});var t=svg.selectAll(".symbol").transition().duration(duration);t.select("path.area").attr("d",function(t){return area(t.values)}),t.select("path.line").style("stroke-opacity",1e-6).attr("d",function(t){return line(t.values)}),t.select("text").attr("transform",function(t){return t=t.values[t.values.length-1],"translate("+(w-60)+","+y(t.price/2+t.price0)+")"}),setTimeout(overlappingArea,duration+delay)}function overlappingArea(){var t=svg.selectAll(".symbol");line.y(function(t){return y(t.price0+t.price)}),t.select(".line").attr("d",function(t){return line(t.values)}),y.domain([0,d3.max(symbols.map(function(t){return t.maxPrice}))]).range([h,0]),area.y0(h).y1(function(t){return y(t.price)}),line.y(function(t){return y(t.price)});var e=t.transition().duration(duration);e.select(".line").style("stroke-opacity",1).attr("d",function(t){return line(t.values)}),e.select(".area").style("fill-opacity",.5).attr("d",function(t){return area(t.values)}),e.select("text").attr("dy",".31em").attr("transform",function(t){return t=t.values[t.values.length-1],"translate("+(w-60)+","+y(t.price)+")"}),svg.append("line").attr("class","line").attr("x1",0).attr("x2",w-60).attr("y1",h).attr("y2",h).style("stroke-opacity",1e-6).transition().duration(duration).style("stroke-opacity",1),setTimeout(groupedBar,duration+delay)}function groupedBar(){x=d3.scale.ordinal().domain(symbols[0].values.map(function(t){return t.date})).rangeBands([0,w-60],.1);var t=d3.scale.ordinal().domain(symbols.map(function(t){return t.key})).rangeBands([0,x.rangeBand()]),e=svg.selectAll(".symbol"),n=e.transition().duration(duration);n.select(".line").style("stroke-opacity",1e-6).remove(),n.select(".area").style("fill-opacity",1e-6).remove(),e.each(function(e,n){d3.select(this).selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("x",function(n){return x(n.date)+t(e.key)}).attr("y",function(t){return y(t.price)}).attr("width",t.rangeBand()).attr("height",function(t){return h-y(t.price)}).style("fill",color(e.key)).style("fill-opacity",1e-6).transition().duration(duration).style("fill-opacity",1)}),setTimeout(stackedBar,duration+delay)}function stackedBar(){x.rangeRoundBands([0,w-60],.1);var t=d3.layout.stack().values(function(t){return t.values}).x(function(t){return t.date}).y(function(t){return t.price}).out(function(t,e,n){t.price0=e}).order("reverse"),e=svg.selectAll(".symbol");t(symbols),y.domain([0,d3.max(symbols[0].values.map(function(t){return t.price+t.price0}))]).range([h,0]);var n=e.transition().duration(duration/2);n.select("text").delay(10*symbols[0].values.length).attr("transform",function(t){return t=t.values[t.values.length-1],"translate("+(w-60)+","+y(t.price/2+t.price0)+")"}),n.selectAll("rect").delay(function(t,e){return 10*e}).attr("y",function(t){return y(t.price0+t.price)}).attr("height",function(t){return h-y(t.price)}).each("end",function(){d3.select(this).style("stroke","#fff").style("stroke-opacity",1e-6).transition().duration(duration/2).attr("x",function(t){return x(t.date)}).attr("width",x.rangeBand()).style("stroke-opacity",1)}),setTimeout(transposeBar,duration+10*symbols[0].values.length+delay)}function transposeBar(){x.domain(symbols.map(function(t){return t.key})).rangeRoundBands([0,w],.2),y.domain([0,d3.max(symbols.map(function(t){return d3.sum(t.values.map(function(t){return t.price}))}))]),d3.layout.stack().x(function(t,e){return e}).y(function(t){return t.price}).out(function(t,e,n){t.price0=e})(d3.zip.apply(null,symbols.map(function(t){return t.values})));var t=svg.selectAll(".symbol").transition().duration(duration/2);t.selectAll("rect").delay(function(t,e){return 10*e}).attr("y",function(t){return y(t.price0+t.price)-1}).attr("height",function(t){return h-y(t.price)+1}).attr("x",function(t){return x(t.symbol)}).attr("width",x.rangeBand()).style("stroke-opacity",1e-6),t.select("text").attr("x",0).attr("transform",function(t){return"translate("+(x(t.key)+x.rangeBand()/2)+","+h+")"}).attr("dy","1.31em").each("end",function(){d3.select(this).attr("x",null).attr("text-anchor","middle")}),svg.select("line").transition().duration(duration).attr("x2",w),setTimeout(donut,duration/2+10*symbols[0].values.length+delay)}function donut(){var t=svg.selectAll(".symbol");t.selectAll("rect").remove();var e=d3.layout.pie().value(function(t){return t.sumPrice}),n=d3.svg.arc();t.append("path").style("fill",function(t){return color(t.key)}).data(function(){return e(symbols)}).transition().duration(duration).tween("arc",function(t){var e=d3.select(this),r=d3.select(this.parentNode.appendChild(this.previousSibling)),a=x(t.data.key),i=h-y(t.data.sumPrice);return function(s){var l=h/2/Math.min(1,s+.001),o=Math.cos(s*Math.PI/2),u=-l+o*(a+x.rangeBand())+(1-o)*(w+h)/2,c=o*h+(1-o)*h/2,d={innerRadius:l-x.rangeBand()/(2-o),outerRadius:l,startAngle:o*(Math.PI/2-i/l)+(1-o)*t.startAngle,endAngle:o*(Math.PI/2)+(1-o)*t.endAngle};e.attr("transform","translate("+u+","+c+")"),e.attr("d",n(d)),r.attr("transform","translate("+n.centroid(d)+")translate("+u+","+c+")rotate("+180*((d.startAngle+d.endAngle)/2+3*Math.PI/2)/Math.PI+")")}}),t.select("text").transition().duration(duration).attr("dy",".31em"),svg.select("line").transition().duration(duration).attr("y1",2*h).attr("y2",2*h).remove(),setTimeout(donutExplode,duration+delay)}function donutExplode(){function t(t){return function(e){var n=d3.select(this),r=d3.select(this.nextSibling),a=d3.interpolate(e,t);for(var s in t)e[s]=t[s];return function(t){var e=a(t);n.attr("d",i(e)),r.attr("transform","translate("+i.centroid(e)+")translate("+w/2+","+h/2+")rotate("+180*((e.startAngle+e.endAngle)/2+3*Math.PI/2)/Math.PI+")")}}}var e=h/2-x.rangeBand()/2,n=h/2,r=2*h-x.rangeBand()/2,a=2*h,i=d3.svg.arc();svg.selectAll(".symbol path").each(function(i,s){i.innerRadius=e,i.outerRadius=n,d3.select(this).transition().duration(duration/2).tween("arc",t({innerRadius:r,outerRadius:a}))}),setTimeout(function(){svg.selectAll("*").remove(),svg.selectAll("g").data(symbols).enter().append("g").attr("class","symbol"),lines()},duration)}var m=[20,20,30,20],w=1060-m[1]-m[3],h=700-m[0]-m[2],x,y,duration=3e3,delay=500,color=d3.scale.category10(),svg=d3.select("body").append("svg").attr("width",w+m[1]+m[3]).attr("height",h+m[0]+m[2]).append("g").attr("transform","translate("+m[3]+","+m[0]+")"),stocks,symbols,line=d3.svg.line().interpolate("basis").x(function(t){return x(t.date)}).y(function(t){return y(t.price)}),axis=d3.svg.line().interpolate("basis").x(function(t){return x(t.date)}).y(h),area=d3.svg.area().interpolate("basis").x(function(t){return x(t.date)}).y1(function(t){return y(t.price)});d3.csv("museen.csv",function(t){var e=d3.time.format("%b %Y").parse;(symbols=d3.nest().key(function(t){return t.symbol}).entries(stocks=t)).forEach(function(t){t.values.forEach(function(t){t.date=e(t.date),t.price=+t.price}),t.maxPrice=d3.max(t.values,function(t){return t.price}),t.sumPrice=d3.sum(t.values,function(t){return t.price})}),symbols.sort(function(t,e){return e.maxPrice-t.maxPrice});svg.selectAll("g").data(symbols).enter().append("g").attr("class","symbol");setTimeout(lines,duration)});
